BootStrap: <PROTOCOL>
From: <LOCATION>

%files
    # make the application repository at-my-current-state available within container
    # for vetted versions of APPLICATION during %post
    <APPLICATION_REPO> /usr/local/application_src

%environment
    export PATH=/usr/local/<APPLICATION>/bin:$PATH

%post
    # Prepare a temp directory
    export TEMP_LOC=`mktemp -d /tmp/rocky_singularity.XXXXX`

    # `make install` target path
    export MOOSE_PREFIX=/usr/local/<APPLICATION>

    # Fix permissions during for `make install`
    umask 022
    # Build MOOSE modules
    export MOOSE_JOBS=32
    echo "JOBS: ${MOOSE_JOBS}"
    if [ "<APPLICATION>" == "moose" ]; then
        cd /usr/local/application_src
    else
        cd /usr/local/application_src/moose
    fi

    ./configure --prefix=${MOOSE_PREFIX}
    if [ "<APPLICATION>" == "moose" ]; then
        cd /usr/local/application_src/modules
    else
        cd /usr/local/application_src/
    fi
    make -j ${MOOSE_JOBS:-32}
    make install -j ${MOOSE_JOBS:-32}

    # Test MOOSE modules
    ./run_tests -j ${MOOSE_JOBS:-12}

    # Test make install copy-inputs
    export PATH=/usr/local/<APPLICATION>/bin:$PATH
    cd ${TEMP_LOC}
    <APPLICATION>-opt --copy-inputs tests
    cd <APPLICATION>/tests
    <APPLICATION>-opt --run -j ${MOOSE_JOBS:-6} -t

    # Clean Up
    rm -rf /usr/local/application_src
    cd /usr/local/<APPLICATION>/
    find . -type f -name "__pycache__" -exec rm -rf {} \;
    rm -rf ${TEMP_LOC}
